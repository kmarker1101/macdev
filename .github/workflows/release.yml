name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    name: Run Tests
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Run tests
        run: bundle exec rspec

  release:
    name: Create Release
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Get tarball SHA256
        id: sha
        run: |
          # Download the auto-generated source tarball
          wget https://github.com/${{ github.repository }}/archive/refs/tags/${{ steps.version.outputs.VERSION }}.tar.gz
          SHA256=$(shasum -a 256 ${{ steps.version.outputs.VERSION }}.tar.gz | cut -d ' ' -f 1)
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "Tarball SHA256: $SHA256"

      - name: Update formula
        run: |
          # Update SHA256 in formula
          sed -i 's/sha256 ""/sha256 "'${{ steps.sha.outputs.SHA256 }}'"/' Formula/macdev.rb

          # Update version in formula URL
          sed -i 's|archive/refs/tags/v.*\.tar\.gz|archive/refs/tags/${{ steps.version.outputs.VERSION }}.tar.gz|' Formula/macdev.rb

      - name: Commit formula update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/macdev.rb
          git commit -m "Update formula for ${{ steps.version.outputs.VERSION }}"
          git push origin HEAD:main

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## macdev ${{ steps.version.outputs.VERSION }}

            Project-isolated development environments on macOS using Homebrew.

            ### Installation via Homebrew

            ```bash
            brew tap kmarker/macdev
            brew install macdev
            ```

            ### Manual Installation

            ```bash
            gem install macdev
            ```

            ### Formula SHA256

            For Homebrew formula maintainers:
            ```
            sha256 "${{ steps.sha.outputs.SHA256 }}"
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
